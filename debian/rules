#!/usr/bin/make -f

# Debian packaging rules for VideoStream library
# Changelog is generated from CHANGELOG.md - see debian/gen-changelog.py

%:
	dh $@ --buildsystem=cmake

# Generate debian/changelog from CHANGELOG.md before configure
execute_before_dh_auto_configure:
	python3 debian/gen-changelog.py

override_dh_auto_configure:
	  dh_auto_configure -- \
			-DCMAKE_LIBRARY_ARCHITECTURE="$(DEB_TARGET_MULTIARCH)" \
			-DCMAKE_BUILD_TYPE=Release \
			-DCMAKE_INSTALL_PREFIX=/usr \
			-DINSTALL_MANUAL=$(INSTALL_MANUAL)

override_dh_auto_build:
	  # Build C library with CMake
	  dh_auto_build
	  # Build Rust CLI binary
	  LD_LIBRARY_PATH=$(CURDIR)/obj-$(DEB_TARGET_GNU_TYPE):$$LD_LIBRARY_PATH \
	    cargo build --release -p videostream-cli

override_dh_auto_install:
	  # Install C library and tools
	  dh_auto_install
	  # Install Rust CLI binary
	  mkdir -p debian/tmp/usr/bin
	  cp target/release/videostream debian/tmp/usr/bin/

override_dh_shlibdeps:

override_dh_installdocs:
	# Install LICENSE, NOTICE, and CHANGELOG to all packages
	dh_installdocs LICENSE NOTICE CHANGELOG.md
	# Install README to -dev package
	dh_installdocs -plibvideostream-dev README.md
