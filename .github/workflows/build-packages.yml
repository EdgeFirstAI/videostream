# GitHub Actions workflow for building and publishing VideoStream packages
# 
# Action Versions (verified November 2025):
# - actions/checkout@v4 (latest)
# - actions/setup-python@v5 (latest)
# - actions/upload-artifact@v4 (latest)
# - actions/download-artifact@v4 (latest)
# - docker/setup-qemu-action@v3 (latest)
# - docker/setup-buildx-action@v3 (latest)
# - docker/login-action@v3 (latest)
# - softprops/action-gh-release@v2 (latest)
# - pypa/gh-action-pypi-publish@release/v1 (stable release tag)
# - aws-actions/configure-aws-credentials@v4 (latest)
# - EnricoMi/publish-unit-test-result-action@v2 (latest)
# - sonarsource/sonarcloud-github-action@v3.0.0 (pinned stable version)
#
# Runner Notes:
# - ubuntu-22.04: Standard GitHub-hosted runner (x86_64)
# - ubuntu-22.04-arm: Custom larger runner (ARM64) configured in organization settings
#   Available for GitHub Team/Enterprise with larger runners enabled

name: Build Packages

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      publish_docker:
        description: 'Publish Docker images'
        required: false
        default: false
        type: boolean

env:
  DOCKER_REGISTRY: deepview

jobs:
  # Build documentation first (needed for packages with INSTALL_MANUAL=ON)
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'  # Match Ubuntu 20.04 default

      - name: Install Sphinx dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen
          pip install -r doc/requirements.txt

      - name: Build HTML documentation
        run: |
          make -C doc html

      - name: Build PDF documentation
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-fonts-extra texlive-latex-extra latexmk
          make -C doc latexpdf
          cp doc/_build/latex/VideoStream.pdf doc/

      - name: Clean documentation artifacts
        run: |
          mv doc/_build/html doc/html
          rm -rf doc/html/_sources doc/html/.buildinfo

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: |
            doc/VideoStream.pdf
            doc/html/
          retention-days: 30

      - name: Archive HTML documentation
        run: |
          cd doc/html && zip -r ../VideoStream-HTML.zip .

      - name: Upload HTML archive
        uses: actions/upload-artifact@v4
        with:
          name: documentation-html-archive
          path: doc/VideoStream-HTML.zip
          retention-days: 30

  # Build ZIP packages (relocatable archives) - Native builds
  build-zip:
    name: Build ZIP (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    needs: build-docs
    strategy:
      matrix:
        platform:
          - name: x86_64
            runner: ubuntu-22.04
            arch: amd64
            cmake_arch: x86_64
          - name: aarch64
            runner: ubuntu-22.04-arm
            arch: arm64
            cmake_arch: aarch64
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download documentation
        uses: actions/download-artifact@v4
        with:
          name: documentation
          path: doc/

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get remove libunwind-*
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-tools \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad

      - name: Build library and create ZIP package
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/opt/videostream \
                -DINSTALL_MANUAL=ON \
                -DENABLE_G2D=OFF \
                -DENABLE_VPU=OFF \
                ..
          make -j$(nproc)
          cpack -G ZIP

      - name: Rename ZIP for tagged releases
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd build
          mv videostream-linux-${{ matrix.platform.cmake_arch }}.zip \
             videostream-${{ github.ref_name }}-linux-${{ matrix.platform.name }}.zip

      - name: Rename ZIP for latest builds
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: |
          cd build
          mv videostream-linux-${{ matrix.platform.cmake_arch }}.zip \
             videostream-latest-linux-${{ matrix.platform.name }}.zip

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: zip-package-${{ matrix.platform.name }}
          path: build/videostream-*.zip
          retention-days: 90

  # Build DEB packages - Native builds
  build-deb:
    name: Build DEB (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    needs: build-docs
    strategy:
      matrix:
        platform:
          - name: x86_64
            runner: ubuntu-22.04
            arch: amd64
            debian_arch: amd64
          - name: aarch64
            runner: ubuntu-22.04-arm
            arch: arm64
            debian_arch: arm64
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download documentation
        uses: actions/download-artifact@v4
        with:
          name: documentation
          path: doc/

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get remove libunwind-*
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            debhelper \
            devscripts \
            cmake \
            pkg-config \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-tools \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad

      - name: Build Debian package
        run: |
          dpkg-buildpackage --no-sign -j$(nproc)

      - name: List generated packages
        run: |
          ls -lh ../*.deb ../*.dsc ../*.tar.* 2>/dev/null || true
          mkdir -p debs
          mv ../*.deb debs/
          mkdir -p source
          mv ../*.dsc ../*.tar.* ../*.buildinfo ../*.changes source/ 2>/dev/null || true

      - name: Upload DEB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-${{ matrix.platform.name }}
          path: "debs/*.deb"
          retention-days: 90

      - name: Upload source package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-source-${{ matrix.platform.name }}
          path: "source/*"
          retention-days: 90

  # Build Python wheel
  build-wheel:
    name: Build Python Wheel
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools

      - name: Build wheel
        run: |
          python -m build --wheel

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel
          path: dist/*.whl
          retention-days: 90

  # Run tests and generate coverage (native builds)
  test-and-coverage:
    name: Run Tests with Coverage
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get remove libunwind-*
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-tools \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            python3 python3-pip python3-dev \
            libxml2-dev libxslt1-dev zlib1g-dev \
            lcov gcovr

      - name: Build library with coverage
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo \
                -DENABLE_COVER=ON \
                -DENABLE_VPU=OFF \
                -DENABLE_G2D=OFF \
                ..
          make -j$(nproc)

      - name: Run tests with coverage
        run: |
          cd build
          export LD_LIBRARY_PATH=$(pwd):$LD_LIBRARY_PATH
          export VIDEOSTREAM_LIBRARY=$(pwd)/libvideostream.so
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install pytest pytest-cov pytest-timeout
          python3 -m pip install -r ../requirements.txt
          python3 -m pytest ../tests -v \
            --junitxml=pytest_results.xml \
            --cov --cov-report=xml:coverage.xml

      - name: Generate C/C++ coverage report
        run: |
          cd build
          gcovr -r .. --xml -o coverage_c.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-x86_64
          path: |
            build/pytest_results.xml
            build/coverage.xml
            build/coverage_c.xml
          retention-days: 30

  # SonarCloud analysis (branches)
  sonarcloud-branch:
    name: SonarCloud Analysis (Branch)
    runs-on: ubuntu-22.04
    needs: test-and-coverage
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download test coverage
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true

      - name: Run SonarCloud scan
        uses: sonarsource/sonarcloud-github-action@v3.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # SonarCloud analysis (pull requests)
  sonarcloud-pr:
    name: SonarCloud Analysis (PR)
    runs-on: ubuntu-22.04
    needs: test-and-coverage
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download test coverage
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true

      - name: Run SonarCloud scan
        uses: sonarsource/sonarcloud-github-action@v3.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Release to GitHub (tagged releases only)
  github-release:
    name: GitHub Release
    runs-on: ubuntu-22.04
    needs: [build-zip, build-deb, build-wheel, build-docs]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Organize release assets
        run: |
          mkdir -p release-assets
          
          # ZIP packages
          find artifacts/zip-package-* -name "*.zip" -exec cp {} release-assets/ \;
          
          # DEB packages
          find artifacts/deb-packages-* -name "*.deb" -exec cp {} release-assets/ \;
          
          # Python wheel
          find artifacts/python-wheel -name "*.whl" -exec cp {} release-assets/ \;
          
          # Documentation
          cp artifacts/documentation/VideoStream.pdf release-assets/
          cp artifacts/documentation-html-archive/VideoStream-HTML.zip release-assets/
          
          # Source archive
          git archive -o release-assets/videostream-${{ github.ref_name }}.zip ${{ github.ref_name }}
          
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          body: |
            # VideoStream ${{ github.ref_name }}
            
            ## Downloads
            
            ### Binary Packages
            - **Linux x86_64 (ZIP)**: `videostream-${{ github.ref_name }}-linux-x86_64.zip`
            - **Linux ARM64 (ZIP)**: `videostream-${{ github.ref_name }}-linux-aarch64.zip`
            - **Debian Packages**: `*.deb` files
            
            ### Python Package
            - **Python Wheel**: `videostream-*.whl`
            - Also available on PyPI: `pip install videostream`
            
            ### Documentation
            - **User Manual (PDF)**: `VideoStream.pdf`
            - **API Documentation (HTML)**: `VideoStream-HTML.zip`
            
            ### Source Code
            - **Source Archive**: `videostream-${{ github.ref_name }}.zip`
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for details.
          draft: false
          prerelease: false

  # Publish to PyPI (tagged releases only)
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-22.04
    needs: [build-wheel, test-and-coverage]
    if: startsWith(github.ref, 'refs/tags/')
    environment: pypi
    permissions:
      id-token: write

    steps:
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: python-wheel
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verbose: true

  # Publish Docker images (tagged releases or manual trigger)
  # Note: Docker images still use Docker buildx for multi-arch support
  # TODO: Disabled until Dockerfile and Dockerfile.musl are created
  # publish-docker:
  #   name: Publish Docker Images
  #   runs-on: ubuntu-22.04
  #   needs: [build-zip, test-and-coverage]
  #   if: |
  #     startsWith(github.ref, 'refs/tags/') || 
  #     (github.event_name == 'workflow_dispatch' && inputs.publish_docker)
  #   permissions:
  #     packages: writete

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up QEMU
  #       uses: docker/setup-qemu-action@v3

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     - name: Login to Docker Hub
  #       uses: docker/login-action@v3
  #       with:
  #         username: ${{ secrets.DOCKERHUB_USERNAME }}
  #         password: ${{ secrets.DOCKERHUB_TOKEN }}

  #     - name: Determine Docker tags
  #       id: tags
  #       run: |
  #         if [[ "${{ github.ref }}" == refs/tags/* ]]; then
  #           VERSION="${{ github.ref_name }}"
  #           echo "image_tags=-t ${{ env.DOCKER_REGISTRY }}/videostream:${VERSION} -t ${{ env.DOCKER_REGISTRY }}/videostream:latest" >> $GITHUB_OUTPUT
  #           echo "slim_tags=-t ${{ env.DOCKER_REGISTRY }}/videostream:${VERSION}-slim -t ${{ env.DOCKER_REGISTRY }}/videostream:latest-slim" >> $GITHUB_OUTPUT
  #         else
  #           echo "image_tags=-t ${{ env.DOCKER_REGISTRY }}/videostream:edge" >> $GITHUB_OUTPUT
  #           echo "slim_tags=-t ${{ env.DOCKER_REGISTRY }}/videostream:edge-slim" >> $GITHUB_OUTPUT
  #         fi

  #     - name: Build and push standard image
  #       run: |
  #         docker buildx build . \
  #           --platform linux/amd64,linux/arm64 \
  #           --push \
  #           ${{ steps.tags.outputs.image_tags }}

  #     - name: Build and push slim image (musl)
  #       run: |
  #         docker buildx build . \
  #           -f Dockerfile.musl \
  #           --platform linux/amd64,linux/arm64 \
  #           --push \
  #           ${{ steps.tags.outputs.slim_tags }}
