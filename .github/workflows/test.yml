# GitHub Actions workflow for testing and code quality
#
# This workflow builds the Debug configuration with coverage enabled,
# runs unit tests (C, Python, and Rust), collects coverage data, and 
# performs static analysis including SonarCloud scanning.
#
# Action Versions (verified November 2025):
# - actions/checkout@v4 (latest)
# - actions/setup-python@v5 (latest)
# - actions/upload-artifact@v4 (latest)
# - dtolnay/rust-toolchain@stable (latest)
# - Swatinem/rust-cache@v2 (latest)
# - SonarSource/sonarcloud-github-action@master
#
# Runner Notes:
# - ubuntu-22.04: Standard GitHub-hosted runner (x86_64)
# - ubuntu-22.04-arm: Custom larger runner (ARM64) configured in organization settings

name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test and Coverage (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    env:
      BUILD_WRAPPER_OUT_DIR: build/sonar
    strategy:
      matrix:
        platform:
          - name: x86_64
            runner: ubuntu-22.04
          - name: aarch64
            runner: ubuntu-22.04-arm
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SonarCloud

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get remove libunwind-*
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-tools \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            python3 python3-pip python3-dev \
            libxml2-dev libxslt1-dev zlib1g-dev \
            lcov gcovr

      - name: Cache SonarCloud packages
        if: matrix.platform.name == 'x86_64'
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Install Build Wrapper
        if: matrix.platform.name == 'x86_64'
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v6

      - name: Configure CMake
        if: matrix.platform.name == 'x86_64'
        run: |
          cmake -S . -B build \
                -DCMAKE_BUILD_TYPE=Debug \
                -DENABLE_COVER=ON \
                -DENABLE_VPU=OFF \
                -DENABLE_G2D=OFF \
                -DSONAR_ANALYSIS=ON

      - name: Configure CMake (without SonarCloud)
        if: matrix.platform.name != 'x86_64'
        run: |
          cmake -S . -B build \
                -DCMAKE_BUILD_TYPE=Debug \
                -DENABLE_COVER=ON \
                -DENABLE_VPU=OFF \
                -DENABLE_G2D=OFF \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build with SonarCloud build wrapper
        if: matrix.platform.name == 'x86_64'
        run: |
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUT_DIR }} \
            cmake --build build -j$(nproc)

      - name: Build without build wrapper
        if: matrix.platform.name != 'x86_64'
        run: |
          cmake --build build -j$(nproc)

      - name: Install Python test dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install pytest pytest-cov pytest-timeout
          python3 -m pip install -r requirements.txt

      - name: Run Python tests with coverage
        run: |
          export LD_LIBRARY_PATH=$(pwd)/build:$LD_LIBRARY_PATH
          export VIDEOSTREAM_LIBRARY=$(pwd)/build/libvideostream.so
          python3 -m pytest tests -v \
            --junitxml=build/pytest_results.xml \
            --cov --cov-report=xml:build/coverage_python.xml

      - name: Generate C/C++ coverage report
        run: |
          gcovr -r . --cobertura -o build/coverage_c.xml build/

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview, clippy, rustfmt

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-${{ matrix.platform.name }}
          cache-on-failure: true

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --version 0.6.16

      - name: Check Rust formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Run Rust tests with coverage
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/build:$LD_LIBRARY_PATH
        run: |
          cargo llvm-cov --workspace --lib --cobertura --output-path build/coverage_rust.xml

      - name: Run SonarCloud scan
        if: matrix.platform.name == 'x86_64'
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.platform.name }}
          path: |
            build/pytest_results.xml
            build/coverage_python.xml
            build/coverage_c.xml
            build/coverage_rust.xml
            build/compile_commands.json
          retention-days: 30
