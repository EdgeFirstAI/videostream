# GitHub Actions workflow for continuous integration
#
# Action Versions (verified November 2025):
# - actions/checkout@v4 (latest)
# - actions/setup-python@v5 (latest)
# - actions/upload-artifact@v4 (latest)
# - codecov/codecov-action@v5 (latest)
#
# Runner Notes:
# - ubuntu-22.04: Standard GitHub-hosted runner (x86_64)
# - ubuntu-22.04-arm: Custom larger runner (ARM64) configured in organization settings
#   Available for GitHub Team/Enterprise with larger runners enabled

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      matrix:
        platform:
          - name: x86_64
            runner: ubuntu-22.04
          - name: aarch64
            runner: ubuntu-22.04-arm
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-tools \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            python3 python3-pip \
            lcov gcovr

      - name: Build library
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo \
                -DENABLE_COVER=ON \
                -DENABLE_VPU=OFF \
                -DENABLE_G2D=OFF \
                ..
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          export LD_LIBRARY_PATH=$(pwd):$LD_LIBRARY_PATH
          export VIDEOSTREAM_LIBRARY=$(pwd)/libvideostream.so
          python3 -m pip install pytest pytest-cov pytest-timeout
          python3 -m pip install -r ../requirements.txt
          python3 -m pytest ../tests -v \
            --junitxml=pytest_results.xml \
            --cov --cov-report=xml:coverage.xml

      - name: Generate coverage report
        run: |
          cd build
          gcovr -r .. --xml -o coverage_c.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.platform.name }}
          path: |
            build/pytest_results.xml
            build/coverage.xml
            build/coverage_c.xml
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./build/coverage.xml,./build/coverage_c.xml
          flags: unittests
          name: codecov-${{ matrix.platform.name }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  build-packages:
    name: Build Debian Package (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - name: x86_64
            runner: ubuntu-22.04
          - name: aarch64
            runner: ubuntu-22.04-arm
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            debhelper \
            devscripts \
            cmake \
            pkg-config \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev

      - name: Build Debian package
        run: |
          TAG=$(git describe --tags --always)
          rm -f debian/changelog
          dch --create --distribution stable --package videostream \
              --newversion ${TAG}-${{ github.run_number }} \
              "CI Build ${{ github.run_number }}"
          dpkg-buildpackage -b --no-sign -j$(nproc)

      - name: List generated packages
        run: |
          ls -lh ../*.deb
          mkdir -p debs
          mv ../*.deb debs/

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package-${{ matrix.platform.name }}
          path: "debs/*.deb"
          retention-days: 90
